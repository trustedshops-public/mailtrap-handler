version: 2.1

orbs:
  semantic-release: trustedshops-public/semantic-release@3.1.3

executors:
  python:
    docker:
      - image: cimg/python:3.10.0
  node:
    docker:
      - image: cimg/node:lts


jobs:
  test:
    executor: python
    steps:
      - checkout
      - run:
          name: Check installing library works
          command: python3 ./setup.py install --user
  pip-publish:
    executor: python
    parameters:
      repository:
        type: string
        description: Name of the repository to publish to
    steps:
      - checkout
      - run:
          name: Set version
          command: |
            if [ ! -z "$CIRCLE_TAG" ]
            then
              echo "Building for tag"
              version="${CIRCLE_TAG}"
            else
              echo "Building for snapshot"
              last_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
              version="${last_tag}.dev${CIRCLE_BUILD_NUM}"
            fi

            echo "export VERSION=${version}" >> $BASH_ENV
      - run:
          name: Install dependencies
          command: |
            pip3 install -r requirements.txt
            pip3 install -r requirements-dev.txt
      - run:
          name: Build package
          command: |
            python3 setup.py sdist bdist_wheel
      - run:
          name: Upload package
          command: |
            twine upload --repository <<parameters.repository>> dist/*
  build-gh-pages:
    executor: node
    steps:
      - add_ssh_keys:
          fingerprints:
            - "6d:da:19:0e:d3:af:29:a8:9e:98:3c:ac:2b:31:f5:04"
      - checkout
      - run:
          name: Install python
          command: |
            sudo apt update
            sudo apt install -y python3 python3-pip
      - run:
          name: Install pdoc
          command: pip3 install pdoc3
      - run:
          name: Install dependencies
          command: |
            pip3 install -r requirements.txt
            pip3 install -r requirements-dev.txt
      - run:
          name: Build html documentation
          command: |
            mkdir gh-pages
            pdoc3 mailtrap_handler -o gh-pages --html --force
            echo '<meta http-equiv="refresh" content="0; URL=https://trustedshops-public.github.io/python-mailtrap-handler/mailtrap_handler/">' > gh-pages/index.html

      - run:
          name: Publish github pages
          command: |
            git config user.email "no-reply@trustedshops.com"
            git config user.name "trustedshops-public-cns-bot"
            npx gh-pages@2.0.1 --dist gh-pages/ --message "docs: Update github pages [ci skip]"

workflows:
  version: 2
  continuous:
    jobs:
      - test:
          filters:
            tags:
              only: /.*/
      - pip-publish:
          name: pip-publish-testpypi
          repository: testpypi
          filters:
            branches:
              only:
                - main
          requires:
            - test
          context:
            - pip-test
      - pip-publish:
          name: pip-publish-pypi
          repository: pypi
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
          requires:
            - test
          context:
            - pip-live
      - build-gh-pages:
          filters:
            branches:
              only:
                - main
          requires:
            - test
            - pip-publish-testpypi
      - semantic-release/with-changelog-github-config:
          name: semantic-release
          filters:
            branches:
              only:
                - main
          requires:
            - test
          context:
            - semantic-release
